---
title: "Obtian and Munge Data"
author: "Matt Lehman"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
  html_document:
    fig_height: 4
    theme: yeti
    highlight: pygments
    toc: true
    toc_depth: 3
    toc_float: true
---

# Packages and Setup

```{r}
library(janitor)
library(tibble)
library(readr)
library(jsonlite)
library(dplyr)
library(tidyr)
library(mattle24utils)
library(sf)
```

```{r}
yrs_of_interest <- tibble(incident_year = c(2006L, 2007L, 2011L, 2012L, 2016L, 2017L))
```

# Read and Munge Data

## Northeast

```{r Philadelphia}
raw_philly <- read_csv("C:/Users/Matt_2/Downloads/incidents_part1_part2.csv")
raw_philly <- clean_names(raw_philly)

res <- raw_philly %>% 
  select(lng, lat, incident_date = dispatch_date,
         description = text_general_code) %>% 
  mutate(incident_year = as.integer(format(incident_date, "%Y"))
         ,city = "Philadelphia") %>% 
  semi_join(yrs_of_interest) %>% 
  mattle24utils::filter_verbose(lng != 0 & lat != 0) %>% 
  mattle24utils::drop_na_verbose(lng, lat) %>% 
  st_as_sf(
    coords = c("lng", "lat")
    ,crs = "+init=EPSG:4269"
  )

raw_philly <- NULL # rm to free memory
```

```{r Pittsburgh}
raw_pitt <-  read_csv("C:/Users/Matt_2/Downloads/archive-police-blotter.csv")
raw_pitt <- clean_names(raw_pitt)

res2 <- res %>% 
  rbind(
    raw_pitt %>% 
      # select(lng = x, lat = y, incident_date = incidenttime,
      #        description = offenses, neighborhood = incidentneighborhood) %>% 
      select(lng = x, lat = y, incident_date = incidenttime,
             description = offenses) %>% 
      mutate(
        incident_date = as.Date(incident_date, format = "%d/%m/%Y")
        ,incident_year = as.integer(format(incident_date, "%Y"))
        ,city = "Pittsburgh"
      ) %>% 
      semi_join(yrs_of_interest) %>% 
      mattle24utils::filter_verbose(lng != 0 & lat != 0) %>% 
      mattle24utils::drop_na_verbose(lng, lat) %>% 
      st_as_sf(
        coords = c("lng", "lat")
        ,crs = "+init=EPSG:4269"
      )
  )

raw_pitt <- NULL 
```

```{r Write Northeast}
write.csv(res, "data/northeast_incidents.csv")
```


# Read and Munge Data

## South

```{r}
res <- tibble() # init the result tibble (will be written to disk)
```

```{r Washington DC}
# TODO: DC also tags these by Census block and tract

# Return a cleaned dataframe with the fields I want to use for analysis given
# the objects returned from `fromJSON`
clean_dc <- function(obj) {
  obj$features$properties %>% 
    clean_names() %>% 
    select(lng = longitude, lat = latitude, incident_date = report_dat,
           neighborhood = neighborhood_cluster) %>% 
    mutate(
      incident_date = as.Date(incident_date)
      ,incident_year = as.integer(format(incident_date, "%Y"))
      ,city = "Washington"
      )
}

raw_dc_11 <- jsonlite::fromJSON("https://opendata.arcgis.com/datasets/9d5485ffae914c5f97047a7dd86e115b_35.geojson")

raw_dc_12 <- jsonlite::fromJSON("https://opendata.arcgis.com/datasets/010ac88c55b1409bb67c9270c8fc18b5_11.geojson")

raw_dc_16 <- jsonlite::fromJSON("https://opendata.arcgis.com/datasets/bda20763840448b58f8383bae800a843_26.geojson")

raw_dc_17 <- jsonlite::fromJSON("https://opendata.arcgis.com/datasets/6af5cb8dc38e4bcbac8168b27ee104aa_38.geojson")

raw_dc <- clean_dc(raw_dc_11) %>% 
  bind_rows(clean_dc(raw_dc_12)) %>% 
  bind_rows(clean_dc(raw_dc_16)) %>% 
  bind_rows(clean_dc(raw_dc_17)) 


res <- res %>% 
  bind_rows(raw_dc) 

raw_dc <- NULL
raw_dc_11 <- NULL
raw_dc_12 <- NULL
raw_dc_16 <- NULL
raw_dc_17 <- NULL
```

```{r Raleigh}
raw_raleigh_old <- GET("https://services.arcgis.com/v400IkDOw1ad7Yad/arcgis/rest/services/Police_Incidents_(UCR)/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json")

raleigh_old_json <- fromJSON(content(raw_raleigh_old, "text"), flatten = TRUE)

raw_raleigh_old <- jsonlite::fromJSON("C:/Users/Matt_2/Downloads/Raleigh_Police_Incidents_SRS.geojson")
raw_raleigh_old <- clean_names(raw_raleigh_old)
raw_raleigh_new <- jsonlite::fromJSON("https://opendata.arcgis.com/datasets/24c0b37fa9bb4e16ba8bcaa7e806c615_0.geojson")
raw_raleigh_new <- clean_names(raw_raleigh_new)

x <- read_csv("https://services.arcgis.com/v400IkDOw1ad7Yad/arcgis/rest/services/Police_Incidents_(UCR)/FeatureServer/0/query?outFields=*&where=1%3D1")
# res <- 
res %>% 
  bind_rows(
    raw_raleigh_old$features$properties %>% 
      clean_names() %>% 
      select(incident_date = inc_datetime, description = lcr_desc) %>% 
      mutate(incident_date = as.Date(incident_date),
             incident_year = as.integer(format(incident_date, "%Y")),
             city = "Raleigh") %>% 
      bind_cols()
      semi_join(yrs_of_interest) %>% 
  ) %>% 
  bind_rows(
    raw
  )
```

## West

```{r}
# result results
res <- NULL
```

```{r Los Angeles}
raw_la <- read_csv("C:/Users/Matt_2/Downloads/Crime_Data_from_2010_to_Present.csv")
raw_la <- clean_names(raw_la)
res <- raw_la %>% 
      select(incident_date = date_occurred, description = crime_code_description, location) %>% 
      mutate(incident_date = as.Date(incident_date, format = "%m/%d/%Y"),
             incident_year = as.integer(format(incident_date, "%Y")),
             city = "Los Angeles"
             ) %>% 
      semi_join(yrs_of_interest) %>% 
      # get geometry (points) from `location`
      tidyr::extract(
        col = location
        ,into = "y"
        ,regex = "([\\d|\\.]*(?=,))"
        ,remove = FALSE
        ,convert = TRUE
      ) %>% 
      tidyr::extract(
        col = location
        ,into = "x"
        ,regex = "((?<=, )[-|\\d|\\.]*)"
        ,remove = FALSE
        ,convert = TRUE
      ) %>% 
      mattle24utils::filter_verbose(x != 0 & y != 0) %>% 
      st_as_sf(
        coords = c("x", "y")
        ,crs = "+init=EPSG:4269"
      ) %>% 
      select(-location) %>% 
      identity()
  )

raw_la <- NULL
```

```{r San Francisco}
raw_sf <- read_csv("C:/Users/Matt_2/Downloads/Police_Department_Incident_Reports__Historical_2003_to_May_2018.csv")
raw_sf <- clean_names(raw_sf)

res <- res %>% 
  rbind(
    raw_sf %>%
      select(x, y, incident_date = date, description = descript) %>% 
      mutate(
        incident_date = as.Date(incident_date, format = "%m/%d/%Y"),
        incident_year = as.integer(format(incident_date, "%Y")),
        city = "San Francisco"
      ) %>% 
      semi_join(yrs_of_interest) %>% 
      mattle24utils::filter_verbose(x != 0 & y != 0) %>% 
      st_as_sf(
        coords = c("x", "y")
        ,crs = "+init=EPSG:4269"
      )
  )

raw_sf <- NULL
```

```{r Write West}
write_sf(res, "data/west_incidents.shp", overwrite = TRUE)
```


```{r}
x <- read_sf("data/west_incidents.shp")
```

