---
title: "Obtian and Munge Data"
author: "Matt Lehman"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
  html_document:
    fig_height: 4
    theme: yeti
    highlight: pygments
    toc: true
    toc_depth: 3
    toc_float: true
---

# Packages and Setup

```{r}
library(janitor)
library(tibble)
library(readr)
library(jsonlite)
library(dplyr)
library(tidyr)
library(mattle24utils)
library(sf)
```

```{r}
yrs_of_interest <- tibble(incident_year = c(2006L, 2007L, 2011L, 2012L, 2016L, 2017L))
```

# Read and Munge Data

## Northeast

```{r Philadelphia}
raw_philly <- read_csv("C:/Users/Matt_2/Downloads/incidents_part1_part2.csv")
raw_philly <- clean_names(raw_philly)

res <- raw_philly %>% 
  select(lng, lat, incident_date = dispatch_date,
         description = text_general_code) %>% 
  mutate(incident_year = as.integer(format(incident_date, "%Y"))
         ,city = "Philadelphia") %>% 
  semi_join(yrs_of_interest) %>% 
  mattle24utils::filter_verbose(lng != 0 & lat != 0) %>% 
  mattle24utils::drop_na_verbose(lng, lat) %>% 
  st_as_sf(
    coords = c("lng", "lat")
    ,crs = "+init=EPSG:4269"
  )

raw_philly <- NULL # rm to free memory
```

```{r Pittsburgh}
raw_pitt_old <-  read_csv("C:/Users/Matt_2/Downloads/archive-police-blotter.csv")
raw_pitt_old <- clean_names(raw_pitt_old)
raw_pitt_new <- read_csv("C:/Users/Matt_2/Downloads/044f2016-1dfd-4ab0-bc1e-065da05fca2e.csv")
raw_pitt_new <- clean_names(raw_pitt_new)

res <- res %>% 
  rbind(
    raw_pitt_old %>% 
      # select(lng = x, lat = y, incident_date = incidenttime,
      #        description = offenses, neighborhood = incidentneighborhood) %>% 
      select(lng = x, lat = y, incident_date = incidenttime,
             description = offenses) %>% 
      mutate(
        incident_date = as.Date(incident_date, format = "%d/%m/%Y")
        ,incident_year = as.integer(format(incident_date, "%Y"))
        ,city = "Pittsburgh"
      ) %>% 
      semi_join(yrs_of_interest) %>% 
      mattle24utils::filter_verbose(lng != 0 & lat != 0) %>% 
      mattle24utils::drop_na_verbose(lng, lat) %>% 
      st_as_sf(
        coords = c("lng", "lat")
        ,crs = "+init=EPSG:4269"
      )
  ) %>% 
  rbind(
    raw_pitt_new %>% 
      select(lng = x, lat = y, incident_date = incidenttime,
             description = offenses) %>% 
      mutate(
        incident_date = as.Date(incident_date)
        ,incident_year = as.integer(format(incident_date, "%Y"))
        ,city = "Pittsburgh"
      ) %>% 
      semi_join(yrs_of_interest) %>% 
      mattle24utils::filter_verbose(lng != 0 & lat != 0) %>% 
      mattle24utils::drop_na_verbose(lng, lat) %>% 
      st_as_sf(
        coords = c("lng", "lat")
        ,crs = "+init=EPSG:4269"
      )
    
  )

# hist(res$incident_date[res$city == "Pittsburgh"], breaks = 30)

raw_pitt_old <- NULL 
raw_pitt_new <- NULL
```

```{r Write Northeast}
saveRDS(res, "data/northeast_incidents.rds")
```


## South

```{r Washington DC, eval = FALSE}
# TODO: DC also tags these by Census block and tract

# Return a cleaned dataframe with the fields I want to use for analysis given
# the objects returned from `fromJSON`
clean_dc <- function(obj) {
  obj$features$properties %>% 
    clean_names() %>% 
    select(lng = longitude, lat = latitude, incident_date = report_dat,
           neighborhood = neighborhood_cluster) %>% 
    mutate(
      incident_date = as.Date(incident_date)
      ,incident_year = as.integer(format(incident_date, "%Y"))
      ,city = "Washington"
      )
}

raw_dc_11 <- jsonlite::fromJSON("https://opendata.arcgis.com/datasets/9d5485ffae914c5f97047a7dd86e115b_35.geojson")

raw_dc_12 <- jsonlite::fromJSON("https://opendata.arcgis.com/datasets/010ac88c55b1409bb67c9270c8fc18b5_11.geojson")

raw_dc_16 <- jsonlite::fromJSON("https://opendata.arcgis.com/datasets/bda20763840448b58f8383bae800a843_26.geojson")

raw_dc_17 <- jsonlite::fromJSON("https://opendata.arcgis.com/datasets/6af5cb8dc38e4bcbac8168b27ee104aa_38.geojson")

res <- clean_dc(raw_dc_11) %>% 
  bind_rows(clean_dc(raw_dc_12)) %>% 
  bind_rows(clean_dc(raw_dc_16)) %>% 
  bind_rows(clean_dc(raw_dc_17)) 

raw_dc_11 <- NULL
raw_dc_12 <- NULL
raw_dc_16 <- NULL
raw_dc_17 <- NULL
```

## West

```{r Los Angeles}
raw_la <- read_csv("C:/Users/Matt_2/Downloads/Crime_Data_from_2010_to_Present.csv")
raw_la <- clean_names(raw_la)
res <- raw_la %>% 
  select(incident_date = date_occurred, description = crime_code_description, location) %>% 
  mutate(incident_date = as.Date(incident_date, format = "%m/%d/%Y"),
         incident_year = as.integer(format(incident_date, "%Y")),
         city = "Los Angeles"
         ) %>% 
  semi_join(yrs_of_interest) %>% 
  # get geometry (points) from `location`
  tidyr::extract(
    col = location
    ,into = "y"
    ,regex = "([\\d|\\.]*(?=,))"
    ,remove = FALSE
    ,convert = TRUE
  ) %>% 
  tidyr::extract(
    col = location
    ,into = "x"
    ,regex = "((?<=, )[-|\\d|\\.]*)"
    ,remove = FALSE
    ,convert = TRUE
  ) %>% 
  mattle24utils::filter_verbose(x != 0 & y != 0) %>% 
  st_as_sf(
    coords = c("x", "y")
    ,crs = "+init=EPSG:4269"
  ) %>% 
  select(-location) %>% 
  identity()

raw_la <- NULL
```

```{r San Francisco}
raw_sf <- read_csv("C:/Users/Matt_2/Downloads/Police_Department_Incident_Reports__Historical_2003_to_May_2018.csv")
raw_sf <- clean_names(raw_sf)

res <- res %>% 
  rbind(
    raw_sf %>%
      select(x, y, incident_date = date, description = descript) %>% 
      mutate(
        incident_date = as.Date(incident_date, format = "%m/%d/%Y"),
        incident_year = as.integer(format(incident_date, "%Y")),
        city = "San Francisco"
      ) %>% 
      semi_join(yrs_of_interest) %>% 
      mattle24utils::filter_verbose(x != 0 & y != 0) %>% 
      st_as_sf(
        coords = c("x", "y")
        ,crs = "+init=EPSG:4269"
      )
  )

raw_sf <- NULL
```

```{r Write West}
saveRDS(res, "data/west_incidents.rds")
```

